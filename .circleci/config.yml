# Javascript Node CircleCI 2.1 configuration file
#
version: 2.1

executors:
  build-executor:
    docker:
      - image: cypress/base:12
        auth:
          username: $DOCKERHUB_USERNAME
          password: $DOCKERHUB_ACCESS_TOKEN

    resource_class: large
    working_directory: ~/amplify-js

  unit-test-executor:
    docker:
      - image: cypress/base:12
        auth:
          username: $DOCKERHUB_USERNAME
          password: $DOCKERHUB_ACCESS_TOKEN

    resource_class: xlarge
    working_directory: ~/amplify-js

  js-test-executor:
    docker:
      - image: cypress/included:8.7.0
      - image: verdaccio/verdaccio
        auth:
          username: $DOCKERHUB_USERNAME
          password: $DOCKERHUB_ACCESS_TOKEN
    resource_class: large

  macos-executor:
    macos:
      xcode: 13.2.1
    resource_class: large

  # For RN apps that need to be upgraded before using latest iOS/macOS
  macos-executor-legacy:
    macos:
      xcode: 11.5.0
    resource_class: large

test_env_vars: &test_env_vars
  environment:
    NPM_REGISTRY: http://0.0.0.0:4873/
    NPM_USER: circleci
    NPM_PASS: circleci
    NPM_EMAIL: circleci@amplify.js

commands:
  publish_to_verdaccio:
    steps:
      - run:
          name: 'Set registry to Verdaccio and verify'
          # If the registry isn't set correctly, fail the job
          command: |
            yarn config set registry $NPM_REGISTRY
            npm set registry $NPM_REGISTRY
            CURRENT_REGISTRY=$(yarn config get registry)
            if [ "$CURRENT_REGISTRY" = "$NPM_REGISTRY" ]; then
              exit 0
            fi
            exit 1
      - run:
          # npm-cli-login allows us to log in to verdaccio in a noninteractive way
          # logs in with NPM_USER, NPM_PASS, and NPM_EMAIL env vars
          name: 'Install and run npm-cli-login'
          command: |
            npm i -g npm-cli-adduser
            npm-cli-adduser
            sleep 1
      - run:
          name: 'Publish to Verdaccio'
          command: |
            cd ~/amplify-js
            git config --global user.email $NPM_EMAIL
            git config --global user.name $NPM_USER
            git status
            git --no-pager diff
            ~/amplify-js/.circleci/retry-yarn-script.sh -s publish:verdaccio -n 5 -r true

  prepare_test_env:
    steps:
      - attach_workspace:
          at: /root
      - restore_cache:
          key: amplify-js-{{ .Branch }}-{{ checksum "~/amplify-js-samples-staging/yarn.lock" }}
      - publish_to_verdaccio

  prepare_no_ui_test_env:
    steps:
      - attach_workspace:
          at: /root
      - restore_cache:
          key: amplify-js-{{ .Branch }}-{{ checksum "~/amplify-js-samples-staging/yarn.lock" }}

  integ_test_js:
    parameters:
      test_name:
        type: string
      framework:
        type: string
      category:
        type: string
      sample_name:
        type: string
      spec:
        # optional - the script will use sample_name by default
        type: string
        default: ''
      browser:
        type: string
        default: ''
    steps:
      - run:
          name: 'Install << parameters.test_name >> sample'
          command: |
            echo "Current NPM registry: " $(yarn config get registry)
            ~/amplify-js/.circleci/retry-yarn-script.sh -s 'install' -n 3
      - run:
          name: 'Run cypress tests for << parameters.test_name >> sample on dev'
          command: |
            cd ~/amplify-js-samples-staging
            ~/amplify-js/.circleci/retry-yarn-script.sh -s 'ci:test << parameters.framework >> << parameters.category >> << parameters.sample_name >> << parameters.spec >> << parameters.browser >> dev' -n 3
      - run:
          name: 'Run cypress tests for << parameters.test_name >> sample on prod'
          command: |
            cd ~/amplify-js-samples-staging
            ~/amplify-js/.circleci/retry-yarn-script.sh -s 'ci:test << parameters.framework >> << parameters.category >> << parameters.sample_name >> << parameters.spec >> << parameters.browser >> prod' -n 3
      - store_artifacts:
          path: ~/amplify-js-samples-staging/cypress/videos
      - store_artifacts:
          path: ~/amplify-js-samples-staging/cypress/screenshots

  integ_test_node_js:
    parameters:
      test_name:
        type: string
      category:
        type: string
      sample_name:
        type: string
    steps:
      - run:
          name: 'Install << parameters.test_name >> sample'
          command: |
            echo "Current NPM registry: " $(yarn config get registry)
            ~/amplify-js/.circleci/retry-yarn-script.sh -s 'install' -n 3
      - run:
          name: 'Run Node tests for << parameters.test_name >> sample'
          command: |
            cd ~/amplify-js-samples-staging
            ~/amplify-js/.circleci/retry-yarn-script.sh -s 'ci:test node << parameters.category >> << parameters.sample_name >> dev' -n 3

  integ_test_cypress_no_ui:
    parameters:
      test_name:
        type: string
      category:
        type: string
      spec:
        type: string
    steps:
      - run:
          name: 'Change directory into build and run link'
          command: |
            cd ~/amplify-js/
            yarn link-all
      - run:
          name: 'Link packages into samples staging root'
          command: |
            yarn link amazon-cognito-identity-js @aws-amplify/core @aws-amplify/cache @aws-amplify/auth
      - run:
          name: 'Run cypress test << parameters.spec >>'
          command: |
            cd ~/amplify-js-samples-staging
            yarn cypress run --headless --spec ./cypress/integration/auth/<< parameters.spec >>.spec.js --config baseUrl=https://aws.amazon.com/
      - store_artifacts:
          path: ~/amplify-js-samples-staging/cypress/videos
      - store_artifacts:
          path: ~/amplify-js-samples-staging/cypress/screenshots

  install_verdaccio:
    steps:
      - run:
          name: Install Verdaccio
          command: npm i -g verdaccio
      - run:
          name: Run Verdaccio
          background: true
          command: |
            cd ~
            verdaccio

  integ_test_rn_ios:
    steps:
      - attach_workspace:
          at: ~/
      - install_verdaccio
      - publish_to_verdaccio
      - run:
          name: Yarn Install
          command: |
            echo "Current NPM registry: " $(yarn config get registry)
            ~/amplify-js/.circleci/retry-yarn-script.sh -s 'install --frozen-lockfile --non-interactive' -n 3
      - run:
          name: Install CocoaPods
          command: |
            cd ios
            pod install
      - run:
          background: true
          command: xcrun simctl boot "iPhone 11" || true
          name: Start iOS simulator (background)
      - run:
          background: true
          command: yarn start
          name: Start Metro Packager (background)
      - run:
          name: Configure Detox
          environment:
            HOMEBREW_NO_AUTO_UPDATE: '1'
          command: |
            brew tap wix/brew
            brew install applesimutils
            yarn global add detox-cli
      - run:
          name: Detox Build
          command: detox build -c ios.sim.debug
      - run:
          environment:
            JEST_JUNIT_OUTPUT_DIR: 'reports/junit'
            JEST_JUNIT_OUTPUT_NAME: 'detox-test-results.xml'
          name: Detox Test
          command: |
            ~/amplify-js/.circleci/retry-yarn-script.sh -s 'detox test -c ios.sim.debug -u' -n 3
      - store_test_results:
          path: reports/junit
      - store_artifacts:
          path: reports/junit

  integ_test_rn_android:
    steps:
      - attach_workspace:
          at: ~/
      - install_verdaccio
      - publish_to_verdaccio
      - run:
          # https://reactnative.dev/docs/environment-setup
          command: |
            cd ~/amplify-js
            ./.circleci/android-rn.sh export-env
          name: Configure Environment Variables
      - restore_cache:
          key: |
            brew-cache-{{ arch }}-{{ .Environment.CACHE_VERSION }}
      - run:
          # https://reactnative.dev/docs/environment-setup
          environment:
            HOMEBREW_NO_AUTO_UPDATE: '1'
          command: |
            brew tap wix/brew >/dev/null
            brew tap homebrew/cask >/dev/null
            brew install android-sdk >/dev/null
            yarn global add detox-cli
            touch .watchmanconfig
            node -v
          name: Configure Detox Environment
      - save_cache:
          key: |
            brew-cache-{{ arch }}-{{ .Environment.CACHE_VERSION }}
          paths:
            - /usr/local/Homebrew
            - ~/Library/Caches/Homebrew
      - run:
          name: Yarn Install
          command: |
            echo "Current NPM registry: " $(yarn config get registry)
            ~/amplify-js/.circleci/retry-yarn-script.sh -s 'install --frozen-lockfile --non-interactive' -n 3
      - run:
          # Install Android Emulator without Android Studio
          command: |
            cd ~/amplify-js
            ./.circleci/android-rn.sh sdkmanager
          name: Install Android Emulator
          shell: /bin/bash -e
      - run:
          # Force ssh key generation for emulators
          command: |
            adb start-server
            adb devices
            adb kill-server
            ls -la ~/.android
          name: ADB Start Stop
      - run:
          # Create Android Emulator without Android Studio
          command: >-
            avdmanager create avd --force --name TestingAVD
            --package "system-images;android-28;default;x86_64"
            --tag default --device pixel
          name: Create Android Emulator
      - run:
          background: true
          command: |
            cd ~/amplify-js
            ./.circleci/android-rn.sh start-emulator
          name: Start Android Emulator (background)
      - run:
          command: |
            cd ~/amplify-js
            ./.circleci/android-rn.sh wait-for-avd
          name: Wait for AVD to be ready
          no_output_timeout: 5m
      - run:
          background: true
          command: yarn start
          name: Start Metro Packager (background)
      - run:
          name: Detox Build
          command: detox build -c android.emu.debug
      - run:
          environment:
            JEST_JUNIT_OUTPUT_DIR: 'reports/junit'
            JEST_JUNIT_OUTPUT_NAME: 'detox-test-results.xml'
          name: Detox Test
          command: |
            ~/amplify-js/.circleci/retry-yarn-script.sh -s 'detox test -c android.emu.debug -u' -n 3
      - store_test_results:
          path: reports/junit
      - store_artifacts:
          path: reports/junit

jobs:
  build:
    executor: build-executor
    steps:
      - checkout
      - run:
          name: yarn install --non-interactive
          # temporarily rename .yarnrc before installing so that we can generate a yarn.lock artifact
          command: |
            mv .yarnrc ._yarnrc
            yarn
      - run: yarn bootstrap
      - run: yarn build
      # storing yarn.lock as an artifact, so that we can quickly get a dependency diff
      # with the last working build in the event that some upstream deps break the build in the future
      - store_artifacts:
          path: yarn.lock
      - run:
          name: delete lockfile after persisting
          command: |
            mv ._yarnrc .yarnrc
            rm yarn.lock
      - save_cache:
          key: amplify-ssh-deps-{{ .Branch }}
          paths:
            - ~/.ssh
      - persist_to_workspace:
          root: /root
          paths:
            - amplify-js

  unit_test:
    executor: unit-test-executor
    steps:
      - attach_workspace:
          at: /root
      - run:
          name: 'Run Amplify JS unit tests'
          command: |
            yarn test
            yarn coverage

  integ_setup:
    executor: build-executor
    working_directory: ~/
    steps:
      - run:
          name: 'Clone Amplify JS Samples repo, install cypress, install react samples authenticator and link amplify packages'
          command: |
            mkdir ~/.ssh/ && echo -e "Host github.com\n\tStrictHostKeyChecking no\n" > ~/.ssh/config
            echo $SSH_HOST_PUBLIC_KEY >> ~/.ssh/known_hosts
            git clone $AMPLIFY_JS_SAMPLES_STAGING_URL
            cd amplify-js-samples-staging
            yarn
      - save_cache:
          key: amplify-js-{{ .Branch }}-{{ checksum "amplify-js-samples-staging/yarn.lock" }}
          paths:
            - ~/.cache ## cache both yarn and Cypress
      - persist_to_workspace:
          root: /root
          paths:
            - amplify-js-samples-staging

  integ_react_auth:
    parameters:
      browser:
        type: string
    executor: js-test-executor
    <<: *test_env_vars
    working_directory: ~/amplify-js-samples-staging/samples
    steps:
      - prepare_test_env
      - integ_test_js:
          test_name: 'React Authenticator'
          framework: react
          category: auth
          sample_name: with-authenticator-legacy
          spec: authenticator
          browser: << parameters.browser >>
      - integ_test_js:
          test_name: 'React Authenticator'
          framework: react
          category: auth
          sample_name: amplify-authenticator
          spec: ui-amplify-authenticator
          browser: << parameters.browser >>
      - integ_test_js:
          test_name: 'Guest to Authenticated User"'
          framework: react
          category: auth
          sample_name: guest-to-auth-user
          spec: guest-to-auth-user
          browser: << parameters.browser >>
      - integ_test_js:
          test_name: 'React Typescript Authenticator'
          framework: react
          category: auth
          sample_name: typescript-amplify-authenticator
          spec: ui-amplify-authenticator
          browser: << parameters.browser >>
      - integ_test_js:
          test_name: 'React Custom Authenticator'
          framework: react
          category: auth
          sample_name: amplify-authenticator
          spec: custom-authenticator
          browser: << parameters.browser >>
      - integ_test_js:
          test_name: 'React Custom Authenticator'
          framework: react
          category: auth
          sample_name: with-authenticator
          spec: ui-amplify-authenticator
          browser: << parameters.browser >>
  integ_angular_auth:
    parameters:
      browser:
        type: string
    executor: js-test-executor
    <<: *test_env_vars
    working_directory: ~/amplify-js-samples-staging/samples
    steps:
      - prepare_test_env
      - integ_test_js:
          test_name: 'Angular Authenticator'
          framework: angular
          category: auth
          sample_name: amplify-authenticator-legacy
          spec: authenticator
          browser: << parameters.browser >>
      - integ_test_js:
          test_name: 'Angular Authenticator'
          framework: angular
          category: auth
          sample_name: amplify-authenticator
          spec: ui-amplify-authenticator
          browser: << parameters.browser >>
      - integ_test_js:
          test_name: 'Angular Custom Authenticator'
          framework: angular
          category: auth
          sample_name: amplify-authenticator
          spec: custom-authenticator
          browser: << parameters.browser >>
  integ_vue_auth:
    parameters:
      browser:
        type: string
    executor: js-test-executor
    <<: *test_env_vars
    working_directory: ~/amplify-js-samples-staging/samples
    steps:
      - prepare_test_env
      - integ_test_js:
          test_name: 'Legacy Vue Authenticator'
          framework: vue
          category: auth
          sample_name: amplify-authenticator-legacy
          spec: authenticator
          browser: << parameters.browser >>
      - integ_test_js:
          test_name: 'Vue 2 Authenticator'
          framework: vue
          category: auth
          sample_name: amplify-authenticator
          spec: ui-amplify-authenticator
          browser: << parameters.browser >>
      - integ_test_js:
          test_name: 'Vue 3 Authenticator'
          framework: vue
          category: auth
          sample_name: authenticator-vue3
          spec: ui-amplify-authenticator
          browser: << parameters.browser >>
      - integ_test_js:
          test_name: 'Vue Custom Authenticator'
          framework: vue
          category: auth
          sample_name: amplify-authenticator
          spec: custom-authenticator
          browser: << parameters.browser >>
  integ_react_predictions:
    parameters:
      browser:
        type: string
    executor: js-test-executor
    <<: *test_env_vars
    working_directory: ~/amplify-js-samples-staging/samples/react/predictions/multi-user-translation
    steps:
      - prepare_test_env
      - integ_test_js:
          test_name: 'React Predictions'
          framework: react
          category: predictions
          sample_name: multi-user-translation
          spec: multiuser-translation
          browser: << parameters.browser >>

  integ_react_interactions:
    parameters:
      browser:
        type: string
    executor: js-test-executor
    <<: *test_env_vars
    working_directory: ~/amplify-js-samples-staging/samples/react/interactions/chatbot-component
    steps:
      - prepare_test_env
      - integ_test_js:
          test_name: 'React Interactions'
          framework: react
          category: interactions
          sample_name: chatbot-component
          spec: chatbot-component
          browser: << parameters.browser >>

  integ_vue_interactions:
    parameters:
      browser:
        type: string
    executor: js-test-executor
    <<: *test_env_vars
    working_directory: ~/amplify-js-samples-staging/samples/vue/interactions/chatbot-component
    steps:
      - prepare_test_env
      - integ_test_js:
          test_name: 'Vue 2 Interactions'
          framework: vue
          category: interactions
          sample_name: chatbot-component
          spec: chatbot-component
          browser: << parameters.browser >>
      - integ_test_js:
          test_name: 'Vue 3 Interactions'
          framework: vue
          category: interactions
          sample_name: chatbot-component-vue3
          spec: chatbot-component
          browser: << parameters.browser >>
  integ_angular_interactions:
    parameters:
      browser:
        type: string
    executor: js-test-executor
    <<: *test_env_vars
    working_directory: ~/amplify-js-samples-staging/samples/angular/interactions/chatbot-component
    steps:
      - prepare_test_env
      - integ_test_js:
          test_name: 'Angular Interactions'
          framework: angular
          category: interactions
          sample_name: chatbot-component
          spec: chatbot-component
          browser: << parameters.browser >>

  integ_react_datastore:
    parameters:
      browser:
        type: string
    executor: js-test-executor
    <<: *test_env_vars
    working_directory: ~/amplify-js-samples-staging/samples/react/datastore/many-to-many
    steps:
      - prepare_test_env
      - integ_test_js:
          test_name: 'React DataStore'
          framework: react
          category: datastore
          sample_name: many-to-many
          spec: many-to-many
          browser: << parameters.browser >>

  integ_react_datastore_v2:
    parameters:
      browser:
        type: string
    executor: js-test-executor
    <<: *test_env_vars
    working_directory: ~/amplify-js-samples-staging/samples/react/datastore/v2/many-to-many-v2
    steps:
      - prepare_test_env
      - integ_test_js:
          test_name: 'React DataStore CLI v2'
          framework: react
          category: datastore
          sample_name: v2/many-to-many-v2
          spec: many-to-many
          browser: << parameters.browser >>

  integ_react_datastore_multi_auth_one_rule:
    parameters:
      browser:
        type: string
    executor: js-test-executor
    <<: *test_env_vars
    working_directory: ~/amplify-js-samples-staging/samples/react/datastore/multi-auth
    steps:
      - prepare_test_env
      - integ_test_js:
          test_name: 'React DataStore Multi-Auth - One Rule'
          framework: react
          category: datastore
          sample_name: multi-auth
          spec: multi-auth-one-rule
          browser: << parameters.browser >>

  integ_react_datastore_multi_auth_one_rule_v2:
    parameters:
      browser:
        type: string
    executor: js-test-executor
    <<: *test_env_vars
    working_directory: ~/amplify-js-samples-staging/samples/react/datastore/v2/multi-auth-v2
    steps:
      - prepare_test_env
      - integ_test_js:
          test_name: 'React DataStore Multi-Auth - One Rule CLI v2'
          framework: react
          category: datastore
          sample_name: v2/multi-auth-v2
          spec: multi-auth-one-rule
          browser: << parameters.browser >>

  integ_react_datastore_multi_auth_two_rules:
    parameters:
      browser:
        type: string
    executor: js-test-executor
    <<: *test_env_vars
    working_directory: ~/amplify-js-samples-staging/samples/react/datastore/multi-auth
    steps:
      - prepare_test_env
      - integ_test_js:
          test_name: 'React DataStore Multi-Auth - Two Rules'
          framework: react
          category: datastore
          sample_name: multi-auth
          spec: multi-auth-two-rules
          browser: << parameters.browser >>

  integ_react_datastore_multi_auth_two_rules_v2:
    parameters:
      browser:
        type: string
    executor: js-test-executor
    <<: *test_env_vars
    working_directory: ~/amplify-js-samples-staging/samples/react/datastore/v2/multi-auth-v2
    steps:
      - prepare_test_env
      - integ_test_js:
          test_name: 'React DataStore Multi-Auth - Two Rules CLI v2'
          framework: react
          category: datastore
          sample_name: v2/multi-auth-v2
          spec: multi-auth-two-rules
          browser: << parameters.browser >>

  integ_react_datastore_multi_auth_three_plus_rules:
    parameters:
      browser:
        type: string
    executor: js-test-executor
    <<: *test_env_vars
    working_directory: ~/amplify-js-samples-staging/samples/react/datastore/multi-auth
    steps:
      - prepare_test_env
      - integ_test_js:
          test_name: 'React DataStore Multi-Auth - Three Plus Rules'
          framework: react
          category: datastore
          sample_name: multi-auth
          spec: multi-auth-three-plus-rules
          browser: << parameters.browser >>

  integ_react_datastore_multi_auth_three_plus_rules_v2:
    parameters:
      browser:
        type: string
    executor: js-test-executor
    <<: *test_env_vars
    working_directory: ~/amplify-js-samples-staging/samples/react/datastore/v2/multi-auth-v2
    steps:
      - prepare_test_env
      - integ_test_js:
          test_name: 'React DataStore Multi-Auth - Three Plus Rules CLI v2'
          framework: react
          category: datastore
          sample_name: v2/multi-auth-v2
          spec: multi-auth-three-plus-rules
          browser: << parameters.browser >>

  integ_react_datastore_subs_disabled:
    parameters:
      browser:
        type: string
    executor: js-test-executor
    <<: *test_env_vars
    working_directory: ~/amplify-js-samples-staging/samples/react/datastore/subs-disabled
    steps:
      - prepare_test_env
      - integ_test_js:
          test_name: 'DataStore - Subs Disabled'
          framework: react
          category: datastore
          sample_name: subs-disabled
          spec: subs-disabled
          browser: << parameters.browser >>

  integ_react_datastore_subs_disabled_v2:
    parameters:
      browser:
        type: string
    executor: js-test-executor
    <<: *test_env_vars
    working_directory: ~/amplify-js-samples-staging/samples/react/datastore/v2/subs-disabled-v2
    steps:
      - prepare_test_env
      - integ_test_js:
          test_name: 'DataStore - Subs Disabled CLI v2'
          framework: react
          category: datastore
          sample_name: v2/subs-disabled-v2
          spec: subs-disabled
          browser: << parameters.browser >>

  integ_react_datastore_consecutive_saves:
    parameters:
      browser:
        type: string
    executor: js-test-executor
    <<: *test_env_vars
    working_directory: ~/amplify-js-samples-staging/samples/react/datastore/consecutive-saves
    steps:
      - prepare_test_env
      - integ_test_js:
          test_name: 'DataStore - Subs Disabled'
          framework: react
          category: datastore
          sample_name: consecutive-saves
          spec: consecutive-saves
          browser: << parameters.browser >>

  integ_react_datastore_consecutive_saves_v2:
    parameters:
      browser:
        type: string
    executor: js-test-executor
    <<: *test_env_vars
    working_directory: ~/amplify-js-samples-staging/samples/react/datastore/v2/consecutive-saves-v2
    steps:
      - prepare_test_env
      - integ_test_js:
          test_name: 'DataStore - Subs Disabled CLI v2'
          framework: react
          category: datastore
          sample_name: v2/consecutive-saves-v2
          spec: consecutive-saves
          browser: << parameters.browser >>

  integ_react_datastore_observe_query:
    parameters:
      browser:
        type: string
    executor: js-test-executor
    <<: *test_env_vars
    working_directory: ~/amplify-js-samples-staging/samples/react/datastore/observe-query
    steps:
      - prepare_test_env
      - integ_test_js:
          test_name: 'DataStore - Observe Query'
          framework: react
          category: datastore
          sample_name: observe-query
          spec: observe-query
          browser: << parameters.browser >>

  integ_react_datastore_observe_query_v2:
    parameters:
      browser:
        type: string
    executor: js-test-executor
    <<: *test_env_vars
    working_directory: ~/amplify-js-samples-staging/samples/react/datastore/v2/observe-query-v2
    steps:
      - prepare_test_env
      - integ_test_js:
          test_name: 'DataStore - Observe Query CLI v2'
          framework: react
          category: datastore
          sample_name: v2/observe-query-v2
          spec: observe-query
          browser: << parameters.browser >>

  integ_react_storage:
    parameters:
      browser:
        type: string
    executor: js-test-executor
    <<: *test_env_vars
    working_directory: ~/amplify-js-samples-staging/samples/react/storage/storageApp
    steps:
      - prepare_test_env
      - integ_test_js:
          test_name: 'React Storage'
          framework: react
          category: storage
          sample_name: storageApp
          spec: storage
          browser: << parameters.browser >>
  integ_react_storage_multipart_progress:
    parameters:
      browser:
        type: string
    executor: js-test-executor
    <<: *test_env_vars
    working_directory: ~/amplify-js-samples-staging/samples/react/storage/multi-part-upload-with-progress
    steps:
      - prepare_test_env
      - integ_test_js:
          test_name: 'React Storage Multi-Part Upload with Progress'
          framework: react
          category: storage
          sample_name: multi-part-upload-with-progress
          spec: multi-part-upload-with-progress
          browser: << parameters.browser >>
  integ_react_storage_copy:
    parameters:
      browser:
        type: string
    executor: js-test-executor
    <<: *test_env_vars
    working_directory: ~/amplify-js-samples-staging/samples/react/storage/multi-part-copy-with-progress
    steps:
      - prepare_test_env
      - integ_test_js:
          test_name: 'React Storage Copy'
          framework: react
          category: storage
          sample_name: multi-part-copy-with-progress
          spec: multi-part-copy-with-progress
          browser: << parameters.browser >>
  integ_react_storage_ui:
    executor: js-test-executor
    <<: *test_env_vars
    working_directory: ~/amplify-js-samples-staging/samples/react/storage/storageComp
    steps:
      - prepare_test_env
      - integ_test_js:
          test_name: 'React Storage UI Components'
          framework: react
          category: storage
          sample_name: storageComp
          spec: storage-comp
  integ_react_amazon_cognito_identity_js_cookie_storage:
    parameters:
      browser:
        type: string
    executor: js-test-executor
    <<: *test_env_vars
    working_directory: ~/amplify-js-samples-staging/samples/react/auth/amazon-cognito-identity-js-cookie-storage
    steps:
      - prepare_test_env
      - integ_test_js:
          test_name: 'amazon-cognito-identity-js-cookie-storage'
          framework: react
          category: auth
          sample_name: amazon-cognito-identity-js-cookie-storage
          spec: amazon-cognito-identity-js-cookie-storage
          browser: << parameters.browser >>
  integ_react_amazon_cognito_identity_js:
    parameters:
      browser:
        type: string
    executor: js-test-executor
    <<: *test_env_vars
    working_directory: ~/amplify-js-samples-staging/samples/react/auth/amazon-cognito-identity-js
    steps:
      - prepare_test_env
      - integ_test_js:
          test_name: 'amazon-cognito-identity-js'
          framework: react
          category: auth
          sample_name: amazon-cognito-identity-js
          spec: amazon-cognito-identity-js
          browser: << parameters.browser >>
  integ_node_amazon_cognito_identity_js:
    executor: js-test-executor
    <<: *test_env_vars
    working_directory: ~/amplify-js-samples-staging/samples/node/auth/amazon-cognito-identity-js
    steps:
      - prepare_test_env
      - integ_test_node_js:
          test_name: 'amazon-cognito-identity-js'
          category: auth
          sample_name: amazon-cognito-identity-js
  integ_react_device_tracking:
    parameters:
      browser:
        type: string
    executor: js-test-executor
    <<: *test_env_vars
    working_directory: ~/amplify-js-samples-staging/samples/react/auth/device-tracking
    steps:
      - prepare_test_env
      - integ_test_js:
          test_name: 'cognito-device-tracking'
          framework: react
          category: auth
          sample_name: device-tracking
          spec: device-tracking
          browser: << parameters.browser >>

  integ_react_delete_user:
    parameters:
      browser:
        type: string
    executor: js-test-executor
    <<: *test_env_vars
    working_directory: ~/amplify-js-samples-staging/samples/react/auth/delete_user
    steps:
      - prepare_test_env
      - integ_test_js:
          test_name: 'delete-user'
          framework: react
          category: auth
          sample_name: delete-user
          spec: delete-user
          browser: << parameters.browser >>
  integ_rn_ios_storage:
    executor: macos-executor-legacy
    <<: *test_env_vars
    working_directory: ~/amplify-js-samples-staging/samples/react-native/storage/StorageApp
    steps:
      - integ_test_rn_ios

  integ_rn_ios_storage_multipart_progress:
    executor: macos-executor
    <<: *test_env_vars
    working_directory: ~/amplify-js-samples-staging/samples/react-native/storage/MultiPartUploadWithProgress
    steps:
      - integ_test_rn_ios

  integ_rn_ios_push_notifications:
    executor: macos-executor
    <<: *test_env_vars
    working_directory: ~/amplify-js-samples-staging/samples/react-native/push-notifications/PushNotificationApp
    steps:
      - integ_test_rn_ios

  integ_rn_android_storage:
    executor: macos-executor-legacy
    <<: *test_env_vars
    working_directory: ~/amplify-js-samples-staging/samples/react-native/storage/StorageApp
    steps:
      - integ_test_rn_android

  integ_rn_android_storage_multipart_progress:
    executor: macos-executor-legacy
    <<: *test_env_vars
    working_directory: ~/amplify-js-samples-staging/samples/react-native/storage/MultiPartUploadWithProgress
    steps:
      - integ_test_rn_android

  integ_rn_ios_datastore_sqlite_adapter:
    executor: macos-executor
    <<: *test_env_vars
    working_directory: ~/amplify-js-samples-staging/samples/react-native/datastore/SQLiteAdapter
    steps:
      - integ_test_rn_ios

  integ_datastore_auth:
    parameters:
      scenario:
        type: string
    executor: js-test-executor
    <<: *test_env_vars
    working_directory: ~/amplify-js-samples-staging/samples
    steps:
      - prepare_test_env
      - integ_test_js:
          test_name: 'DataStore Auth - Chrome'
          framework: react
          category: datastore
          sample_name: << parameters.scenario >>
          spec: << parameters.scenario >>
          browser: chrome
      - integ_test_js:
          test_name: 'DataStore Auth - Firefox'
          framework: react
          category: datastore
          sample_name: << parameters.scenario >>
          spec: << parameters.scenario >>
          browser: firefox

  integ_datastore_auth_v2:
    parameters:
      scenario:
        type: string
    executor: js-test-executor
    <<: *test_env_vars
    working_directory: ~/amplify-js-samples-staging/samples
    steps:
      - prepare_test_env
      - integ_test_js:
          test_name: 'DataStore Auth CLI v2 - Chrome'
          framework: react
          category: datastore
          sample_name: v2/<< parameters.scenario >>-v2
          spec: << parameters.scenario >>
          browser: chrome
      - integ_test_js:
          test_name: 'DataStore Auth CLI v2 - Firefox'
          framework: react
          category: datastore
          sample_name: v2/<< parameters.scenario >>-v2
          spec: << parameters.scenario >>
          browser: firefox

  integ_duplicate_packages:
    parameters:
      browser:
        type: string
    executor: js-test-executor
    <<: *test_env_vars
    working_directory: ~/amplify-js-samples-staging/samples/react/version-conflict/duplicate-packages
    steps:
      - prepare_test_env
      - integ_test_js:
          test_name: 'Duplicate Package Errors'
          framework: react
          category: version-conflict
          sample_name: duplicate-packages
          spec: duplicate-packages
          browser: << parameters.browser >>
  integ_auth_test_cypress_no_ui:
    working_directory: ~/amplify-js-samples-staging/
    executor: js-test-executor
    steps:
      - prepare_no_ui_test_env
      - integ_test_cypress_no_ui:
          test_name: 'Token revocation'
          category: 'auth'
          spec: 'token-revocation'
  integ_react_geo:
    parameters:
      browser:
        type: string
    executor: js-test-executor
    <<: *test_env_vars
    working_directory: ~/amplify-js-samples-staging/samples
    steps:
      - prepare_test_env
      - integ_test_js:
          test_name: 'Display Map'
          framework: react
          category: geo
          sample_name: display-map
          spec: display-map
          browser: << parameters.browser >>
      - integ_test_js:
          test_name: 'Marker Map'
          framework: react
          category: geo
          sample_name: marker-map
          spec: marker-map
          browser: << parameters.browser >>
      - integ_test_js:
          test_name: 'Cluster Map'
          framework: react
          category: geo
          sample_name: cluster-marker-map
          spec: cluster-marker-map
          browser: << parameters.browser >>
      - integ_test_js:
          test_name: 'Search Map'
          framework: react
          category: geo
          sample_name: search-map
          spec: search-map
          browser: << parameters.browser >>
      - integ_test_js:
          test_name: 'Search Outside Map'
          framework: react
          category: geo
          sample_name: search-outside-map
          spec: search-outside-map
          browser: << parameters.browser >>
  deploy:
    executor: macos-executor
    working_directory: ~/amplify-js
    steps:
      - attach_workspace:
          at: ~/
      - run:
          name: 'Publish to Amplify Package'
          command: |
            echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" >> ~/.npmrc
            npm whoami
            git config --global user.email $GITHUB_EMAIL
            git config --global user.name $GITHUB_USER
            git status
            git --no-pager diff
            yarn publish:$CIRCLE_BRANCH

  post_release:
    executor: build-executor
    steps:
      - attach_workspace:
          at: /root
      - restore_cache:
          keys:
            - amplify-ssh-deps-{{ .Branch }}
            - amplify-ssh-deps
      - run:
          name: 'Post-release steps'
          command: |
            git config --global user.email $GITHUB_EMAIL
            git config --global user.name $GITHUB_USER
            git pull origin release
            yarn workspace @aws-amplify/core build
            git add ./packages/core/src/Platform/version.ts
            git commit -m "chore(release): update version.ts [ci skip]"
            git push origin release
            git push origin release:main

releasable_branches: &releasable_branches
  branches:
    only:
      - release
      - main
      - ui-components/main
      - 1.0-stable
      - geo/main

test_browsers: &test_browsers
  browser: [chrome, firefox]

datastore_auth_scenarios: &datastore_auth_scenarios
  scenario: [
      owner-based-default, # TODO: Add `owner-based-operations` when tests pass
      static-user-pool-groups-default,
      static-user-pool-groups-operations,
      owner-and-group-different-models-default,
      owner-and-group-same-model-default,
      owner-and-group-same-model-operations,
      dynamic-user-pool-groups-default,
      dynamic-user-pool-groups-owner-based-default,
      private-auth-default,
      private-auth-iam,
      public-auth-default,
      public-auth-iam,
      owner-custom-claim-default,
      owner-custom-field-default,
    ]

workflows:
  build_test_deploy:
    jobs:
      - build
      - integ_setup:
          filters:
            <<: *releasable_branches
      - unit_test:
          requires:
            - build
      - integ_react_auth:
          requires:
            - integ_setup
            - build
          filters:
            <<: *releasable_branches
          matrix:
            parameters:
              <<: *test_browsers
      - integ_auth_test_cypress_no_ui:
          requires:
            - integ_setup
            - build
          filters:
            <<: *releasable_branches
      - integ_angular_auth:
          requires:
            - integ_setup
            - build
          filters:
            <<: *releasable_branches
          matrix:
            parameters:
              <<: *test_browsers
      - integ_vue_auth:
          requires:
            - integ_setup
            - build
          filters:
            <<: *releasable_branches
          matrix:
            parameters:
              <<: *test_browsers
      - integ_react_predictions:
          requires:
            - integ_setup
            - build
          filters:
            <<: *releasable_branches
          matrix:
            parameters:
              <<: *test_browsers
      - integ_react_interactions:
          requires:
            - integ_setup
            - build
          filters:
            <<: *releasable_branches
          matrix:
            parameters:
              <<: *test_browsers
      - integ_vue_interactions:
          requires:
            - integ_setup
            - build
          filters:
            <<: *releasable_branches
          matrix:
            parameters:
              <<: *test_browsers
      - integ_angular_interactions:
          requires:
            - integ_setup
            - build
          filters:
            <<: *releasable_branches
          matrix:
            parameters:
              <<: *test_browsers
      - integ_react_datastore:
          requires:
            - integ_setup
            - build
          filters:
            <<: *releasable_branches
          matrix:
            parameters:
              <<: *test_browsers
      - integ_react_datastore_v2:
          requires:
            - integ_setup
            - build
          filters:
            <<: *releasable_branches
          matrix:
            parameters:
              <<: *test_browsers
      - integ_react_datastore_multi_auth_one_rule:
          requires:
            - integ_setup
            - build
          filters:
            <<: *releasable_branches
          matrix:
            parameters:
              <<: *test_browsers
      - integ_react_datastore_multi_auth_one_rule_v2:
          requires:
            - integ_setup
            - build
          filters:
            <<: *releasable_branches
          matrix:
            parameters:
              <<: *test_browsers
      - integ_react_datastore_multi_auth_two_rules:
          requires:
            - integ_setup
            - build
          filters:
            <<: *releasable_branches
          matrix:
            parameters:
              <<: *test_browsers
      - integ_react_datastore_multi_auth_two_rules_v2:
          requires:
            - integ_setup
            - build
          filters:
            <<: *releasable_branches
          matrix:
            parameters:
              <<: *test_browsers
      - integ_react_datastore_multi_auth_three_plus_rules:
          requires:
            - integ_setup
            - build
          filters:
            <<: *releasable_branches
          matrix:
            parameters:
              <<: *test_browsers
      - integ_react_datastore_multi_auth_three_plus_rules_v2:
          requires:
            - integ_setup
            - build
          filters:
            <<: *releasable_branches
          matrix:
            parameters:
              <<: *test_browsers
      - integ_react_datastore_subs_disabled:
          requires:
            - integ_setup
            - build
          filters:
            <<: *releasable_branches
          matrix:
            parameters:
              <<: *test_browsers
      - integ_react_datastore_subs_disabled_v2:
          requires:
            - integ_setup
            - build
          filters:
            <<: *releasable_branches
          matrix:
            parameters:
              <<: *test_browsers
      - integ_react_datastore_consecutive_saves:
          requires:
            - integ_setup
            - build
          filters:
            <<: *releasable_branches
          matrix:
            parameters:
              <<: *test_browsers
      - integ_react_datastore_consecutive_saves_v2:
          requires:
            - integ_setup
            - build
          filters:
            <<: *releasable_branches
          matrix:
            parameters:
              <<: *test_browsers
      - integ_react_datastore_observe_query:
          requires:
            - integ_setup
            - build
          filters:
            <<: *releasable_branches
          matrix:
            parameters:
              <<: *test_browsers
      - integ_react_datastore_observe_query_v2:
          requires:
            - integ_setup
            - build
          filters:
            <<: *releasable_branches
          matrix:
            parameters:
              <<: *test_browsers
      - integ_react_storage:
          requires:
            - integ_setup
            - build
          filters:
            <<: *releasable_branches
          matrix:
            parameters:
              <<: *test_browsers
      - integ_react_storage_multipart_progress:
          requires:
            - integ_setup
            - build
          filters:
            <<: *releasable_branches
          matrix:
            parameters:
              <<: *test_browsers
      - integ_react_storage_copy:
          requires:
            - integ_setup
            - build
          filters:
            <<: *releasable_branches
          matrix:
            parameters:
              <<: *test_browsers
      - integ_react_storage_ui:
          requires:
            - integ_setup
            - build
          filters:
            <<: *releasable_branches
      - integ_react_amazon_cognito_identity_js_cookie_storage:
          requires:
            - integ_setup
            - build
          filters:
            <<: *releasable_branches
          matrix:
            parameters:
              <<: *test_browsers
      - integ_react_amazon_cognito_identity_js:
          requires:
            - integ_setup
            - build
          filters:
            <<: *releasable_branches
          matrix:
            parameters:
              <<: *test_browsers
      - integ_node_amazon_cognito_identity_js:
          requires:
            - integ_setup
            - build
          filters:
            <<: *releasable_branches
      - integ_react_device_tracking:
          requires:
            - integ_setup
            - build
          filters:
            <<: *releasable_branches
          matrix:
            parameters:
              <<: *test_browsers
      - integ_react_delete_user:
          requires:
            - integ_setup
            - build
          filters:
            <<: *releasable_branches
          matrix:
            parameters:
              <<: *test_browsers
      - integ_rn_ios_storage:
          requires:
            - integ_setup
            - build
          filters:
            <<: *releasable_branches
      - integ_rn_ios_storage_multipart_progress:
          requires:
            - integ_setup
            - build
          filters:
            <<: *releasable_branches
      - integ_rn_ios_push_notifications:
          requires:
            - integ_setup
            - build
          filters:
            <<: *releasable_branches
      - integ_rn_android_storage:
          requires:
            - integ_setup
            - build
          filters:
            <<: *releasable_branches
      - integ_rn_android_storage_multipart_progress:
          requires:
            - integ_setup
            - build
          filters:
            <<: *releasable_branches
      - integ_rn_ios_datastore_sqlite_adapter:
          requires:
            - integ_setup
            - build
          filters:
            <<: *releasable_branches
      - integ_datastore_auth:
          requires:
            - integ_setup
            - build
          filters:
            <<: *releasable_branches
          matrix:
            parameters:
              <<: *datastore_auth_scenarios
      - integ_datastore_auth_v2:
          requires:
            - integ_setup
            - build
          filters:
            <<: *releasable_branches
          matrix:
            parameters:
              <<: *datastore_auth_scenarios
      - integ_duplicate_packages:
          requires:
            - integ_setup
            - build
          filters:
            <<: *releasable_branches
          matrix:
            parameters:
              <<: *test_browsers
      - integ_react_geo:
          requires:
            - integ_setup
            - build
          filters:
            <<: *releasable_branches
          browser: chrome
      - deploy:
          filters:
            <<: *releasable_branches
          requires:
            - unit_test
            - integ_react_delete_user
            - integ_react_predictions
            - integ_react_datastore
            - integ_react_datastore_v2
            - integ_react_datastore_multi_auth_one_rule
            - integ_react_datastore_multi_auth_one_rule_v2
            - integ_react_datastore_multi_auth_two_rules
            - integ_react_datastore_multi_auth_two_rules_v2
            - integ_react_datastore_multi_auth_three_plus_rules
            - integ_react_datastore_multi_auth_three_plus_rules_v2
            - integ_react_datastore_subs_disabled
            - integ_react_datastore_subs_disabled_v2
            - integ_react_datastore_consecutive_saves
            - integ_react_datastore_consecutive_saves_v2
            - integ_react_datastore_observe_query
            - integ_react_datastore_observe_query_v2
            - integ_react_storage
            - integ_react_storage_multipart_progress
            - integ_react_storage_copy
            - integ_react_storage_ui
            - integ_react_interactions
            - integ_angular_interactions
            - integ_vue_interactions
            - integ_react_amazon_cognito_identity_js_cookie_storage
            - integ_react_amazon_cognito_identity_js
            - integ_node_amazon_cognito_identity_js
            - integ_react_auth
            - integ_angular_auth
            - integ_vue_auth
            - integ_rn_ios_storage
            - integ_rn_ios_storage_multipart_progress
            - integ_rn_android_storage_multipart_progress
            - integ_rn_ios_push_notifications
            - integ_rn_android_storage
            - integ_rn_ios_datastore_sqlite_adapter
            - integ_datastore_auth
            - integ_datastore_auth_v2
            - integ_duplicate_packages
            - integ_auth_test_cypress_no_ui
            - integ_react_geo
      - post_release:
          filters:
            branches:
              only:
                - release
          requires:
            - deploy
